<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChronoVerse</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Roboto', Arial, sans-serif;
      background: linear-gradient(120deg, #e0e7ef 0%, #cfd9df 100%);
      color: #222;
      overflow: hidden;
    }
    
    .main-flex {
      display: flex;
      flex-direction: row;
      height: 100vh;
      width: 100vw;
    }
    
    .sidebar {
      width: 25%;
      min-width: 250px;
      max-width: 320px;
      background: #f7f9fb;
      border-right: 1px solid #e0e7ef;
      box-shadow: 0 0 16px 0 rgba(207, 217, 223, 0.33);
      border-radius: 0 18px 18px 0;
      overflow-y: auto;
      padding: 18px;
      display: flex;
      flex-direction: column;
      z-index: 10;
    }
    
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
    }
    
    .sidebar h2 {
      font-family: 'Roboto', Arial, sans-serif;
      font-size: 1.2rem;
      letter-spacing: 1px;
      color: #3a3a5a;
      font-weight: 700;
    }
    
    #homeBtn {
      background: #e0e7ef;
      color: #3a3a5a;
      font-family: 'Roboto', Arial, sans-serif;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(207, 217, 223, 0.2);
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    #homeBtn:hover {
      background: #cfd9df;
      box-shadow: 0 4px 12px rgba(207, 217, 223, 0.3);
    }
    
    .top-list {
      list-style-type: none;
      padding: 0;
      margin-top: 12px;
    }
    
    .top-list li {
      padding: 12px 10px;
      border: 1px solid #e0e7ef;
      margin: 8px 0;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      position: relative;
      font-size: 1.05rem;
      color: #3a3a5a;
      font-family: 'Roboto', Arial, sans-serif;
      box-shadow: 0 2px 8px rgba(207, 217, 223, 0.13);
      transition: all 0.2s;
    }
    
    .top-list li:hover {
      background: #e0e7ef;
      color: #222;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(207, 217, 223, 0.2);
    }
    
    .details {
      display: none;
      background: #f7f9fb;
      border: 1px solid #e0e7ef;
      border-radius: 8px;
      padding: 10px;
      margin-top: 8px;
      color: #222;
      box-shadow: 0 2px 8px rgba(207, 217, 223, 0.13);
    }
    
    .details button {
      margin-right: 10px;
      padding: 7px 16px;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      background: #e0e7ef;
      color: #3a3a5a;
      font-family: 'Roboto', Arial, sans-serif;
      font-weight: 700;
      font-size: 0.9rem;
      box-shadow: 0 2px 8px rgba(207, 217, 223, 0.13);
      transition: background 0.2s;
    }
    
    .details button:hover {
      background: #cfd9df;
    }
    
    .right-panel {
      width: 25%;
      min-width: 250px;
      max-width: 320px;
      background: #f7f9fb;
      border-left: 1px solid #e0e7ef;
      box-shadow: 0 0 16px 0 rgba(207, 217, 223, 0.33);
      border-radius: 18px 0 0 18px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      z-index: 10;
    }
    
    #addPhotoBtn {
      margin-bottom: 18px;
      padding: 12px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Roboto', Arial, sans-serif;
      font-weight: 700;
      font-size: 1rem;
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      transition: all 0.2s;
    }
    
    #addPhotoBtn:hover {
      background: #0069d9;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4);
    }
    
    .login-container,
    .user-info {
      display: none;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(207, 217, 223, 0.13);
      padding: 18px;
      margin-bottom: 18px;
    }
    
    .login-container.active,
    .user-info.active {
      display: block;
    }
    
    .login-container h2,
    .user-info h2 {
      font-family: 'Roboto', Arial, sans-serif;
      text-align: center;
      margin-bottom: 20px;
      color: #3a3a5a;
      font-size: 1.1rem;
      font-weight: 700;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #3a3a5a;
      font-family: 'Roboto', Arial, sans-serif;
      font-size: 1rem;
      font-weight: 700;
    }
    
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #e0e7ef;
      border-radius: 7px;
      background: #f7f9fb;
      color: #222;
      font-size: 1rem;
      font-family: 'Roboto', Arial, sans-serif;
    }
    
    .form-group button {
      width: 100%;
      padding: 12px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Roboto', Arial, sans-serif;
      font-weight: 700;
      font-size: 1rem;
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      transition: all 0.2s;
    }
    
    .form-group button:hover {
      background: #0069d9;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4);
    }
    
    #chooseLocationLabel {
      display: none;
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #3a3a5a;
      color: #fff;
      padding: 10px 20px;
      border-radius: 8px;
      font-family: 'Roboto', Arial, sans-serif;
      font-size: 1rem;
      font-weight: 700;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    #extraLinks div {
      color: #888;
      background: #f7f9fb;
      border-radius: 7px;
      margin-bottom: 6px;
      padding: 8px 12px;
      font-family: 'Roboto', Arial, sans-serif;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }
    
    .map-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
      z-index: 1;
      min-width: 0;
    }
    
    #map {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      box-shadow: 0 0 16px rgba(207, 217, 223, 0.33);
      background: #e0e7ef;
      position: relative;
      z-index: 2;
    }
    
    .photo-form {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #e0e7ef;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
      padding: 24px;
      display: none;
      z-index: 1000;
      color: #222;
      font-family: 'Roboto', Arial, sans-serif;
      font-size: 1.05rem;
      width: 350px;
    }
    
    .photo-form.active {
      display: block;
    }
    
    .photo-form h3 {
      margin-bottom: 15px;
      color: #3a3a5a;
      text-align: center;
    }
    
    .photo-form p {
      margin-bottom: 15px;
      padding: 10px;
      background: #f7f9fb;
      border-radius: 8px;
    }
    
    .photo-form input {
      width: 100%;
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #e0e7ef;
      border-radius: 8px;
    }
    
    .photo-form-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    
    .photo-form-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Roboto', Arial, sans-serif;
      font-weight: 700;
      transition: all 0.2s;
    }
    
    .photo-form-buttons button:first-child {
      background: #007bff;
      color: #fff;
    }
    
    .photo-form-buttons button:first-child:hover {
      background: #0069d9;
    }
    
    .photo-form-buttons button:last-child {
      background: #6c757d;
      color: #fff;
    }
    
    .photo-form-buttons button:last-child:hover {
      background: #5a6268;
    }
    
    .error {
      color: #dc3545;
      margin-top: 10px;
      text-align: center;
      font-weight: 700;
    }
    
    .user-stats {
      margin-bottom: 15px;
      padding: 10px;
      background: #f7f9fb;
      border-radius: 8px;
    }
    
    .user-stats p {
      margin: 8px 0;
    }
    
    #switchUserBtn {
      width: 100%;
      padding: 10px;
      background: #e0e7ef;
      color: #3a3a5a;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Roboto', Arial, sans-serif;
      font-weight: 700;
      margin-bottom: 20px;
      transition: all 0.2s;
    }
    
    #switchUserBtn:hover {
      background: #cfd9df;
    }
    
    /* Marker stilleri */
    .custom-marker {
      border: 2px solid #fff;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    /* Yükleniyor göstergesi */
    .loading {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 8px;
      z-index: 1000;
      text-align: center;
    }
    
    /* Responsive tasarım için medya sorguları */
    @media (max-width: 992px) {
      .main-flex {
        flex-direction: column;
      }
      
      .sidebar, .right-panel {
        width: 100%;
        max-width: none;
        border-radius: 0;
        border-right: none;
        border-left: none;
      }
      
      .sidebar {
        border-bottom: 1px solid #e0e7ef;
        max-height: 30vh;
      }
      
      .right-panel {
        border-top: 1px solid #e0e7ef;
        max-height: 30vh;
        order: 3;
      }
      
      .map-container {
        order: 2;
        height: 40vh;
      }
    }

    @media (max-width: 768px) {
      .sidebar, .right-panel {
        padding: 12px;
      }
      
      .photo-form {
        width: 90%;
        max-width: 320px;
        padding: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="main-flex">
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>Top 10 Users</h2>
        <button id="homeBtn">Home</button>
      </div>
      <ul class="top-list" id="topList"></ul>
    </div>

    <div class="map-container">
      <div id="chooseLocationLabel">Haritada bir konum seçin</div>
      <div id="map"></div>
      <div class="photo-form" id="photoForm">
        <h3>Fotoğraf Ekle</h3>
        <p id="photoLocation">Konum: Seçilmedi</p>
        <input type="file" id="photoInput" accept="image/*">
        <div class="photo-form-buttons">
          <button id="uploadButton">Yükle</button>
          <button onclick="closeForm()">İptal</button>
        </div>
      </div>
      <div class="loading" id="loadingIndicator">
        <p>Fotoğraf yükleniyor...</p>
      </div>
    </div>

    <div class="right-panel">
      <button id="addPhotoBtn">Fotoğraf Ekle +</button>
      
      <div class="login-container active" id="loginContainer">
        <h2>Giriş Yap</h2>
        <div class="form-group">
          <label for="username">Kullanıcı Adı</label>
          <input type="text" id="username" placeholder="Kullanıcı adınız">
        </div>
        <div class="form-group">
          <label for="password">Şifre</label>
          <input type="password" id="password" placeholder="Şifreniz">
        </div>
        <div class="form-group">
          <button id="loginButton">Giriş Yap</button>
        </div>
        <p class="error" id="loginError"></p>
      </div>
      
      <div class="user-info" id="userInfo">
        <h2 id="userGreeting">Hoş geldin!</h2>
        <div class="user-stats" id="userStats"></div>
        <button id="switchUserBtn">Kullanıcı Değiştir</button>
        <div id="extraLinks">
          <div>*VR Tour</div>
          <div>*Chalanges</div>
          <div>*NFT collection</div>
          <div>*ChronoGuide</div>
          <div>*Navigation</div>
          <div>*TimeLine</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Ana uygulama state'i
    const AppState = {
      map: null,
      currentLatLng: null,
      allMarkers: [],
      currentUser: null,
      users: [
        { username: "Armi", password: "1982", coin: 0, posts: 0, followers: [], followingList: [] },
        { username: "Burcu", password: "2302", coin: 0, posts: 0, followers: [], followingList: [] },
        { username: "Dlilara", password: "1234", coin: 0, posts: 0, followers: [], followingList: [] },
        { username: "Jora", password: "abcd", coin: 0, posts: 0, followers: [], followingList: [] },
        { username: "Evgeny", password: "evgn", coin: 0, posts: 0, followers: [], followingList: [] },
        { username: "Arnold", password: "arnl", coin: 0, posts: 0, followers: [], followingList: [] },
        { username: "Will", password: "mia", coin: 0, posts: 0, followers: [], followingList: [] },
        { username: "Bobuz", password: "6868", coin: 0, posts: 0, followers: [], followingList: [] },
        { username: "Samed", password: "5868", coin: 0, posts: 0, followers: [], followingList: [] },
        { username: "Sener", password: "1984", coin: 0, posts: 0, followers: [], followingList: [] },
      ]
    };

    // DOM elementlerini önceden seç
    const DOM = {
      map: document.getElementById('map'),
      topList: document.getElementById('topList'),
      homeBtn: document.getElementById('homeBtn'),
      addPhotoBtn: document.getElementById('addPhotoBtn'),
      photoForm: document.getElementById('photoForm'),
      chooseLocationLabel: document.getElementById('chooseLocationLabel'),
      photoLocation: document.getElementById('photoLocation'),
      photoInput: document.getElementById('photoInput'),
      loginContainer: document.getElementById('loginContainer'),
      userInfo: document.getElementById('userInfo'),
      userGreeting: document.getElementById('userGreeting'),
      userStats: document.getElementById('userStats'),
      username: document.getElementById('username'),
      password: document.getElementById('password'),
      loginError: document.getElementById('loginError'),
      switchUserBtn: document.getElementById('switchUserBtn'),
      loginButton: document.getElementById('loginButton'),
      uploadButton: document.getElementById('uploadButton'),
      loadingIndicator: document.getElementById('loadingIndicator')
    };

    // Yardımcı fonksiyonlar
    const Helpers = {
      showLoading: () => DOM.loadingIndicator.style.display = 'block',
      hideLoading: () => DOM.loadingIndicator.style.display = 'none',
      showError: (message) => DOM.loginError.textContent = message,
      clearError: () => DOM.loginError.textContent = ''
    };

    // Harita işlemleri
    const MapManager = {
      init: () => {
        AppState.map = L.map('map').setView([39, 35], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(AppState.map);
        
        setTimeout(() => { AppState.map.invalidateSize(); }, 100);
      },
      
      addMarker: (latlng, imgSrc, user) => {
        // Base64 görüntüyü yükle
        const img = new Image();
        img.onload = function() {
          // Canvas üzerinde küçük bir önizleme oluştur
          const canvas = document.createElement('canvas');
          const size = 40;
          canvas.width = size;
          canvas.height = size;
          const ctx = canvas.getContext('2d');
          
          // Yuvarlak bir clip oluştur
          ctx.beginPath();
          ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
          ctx.closePath();
          ctx.clip();
          
          // Resmi çiz
          ctx.drawImage(img, 0, 0, size, size);
          
          // Canvas'tan data URL al
          const dataUrl = canvas.toDataURL('image/jpeg');
          
          // Marker oluştur
          const icon = L.icon({
            iconUrl: dataUrl,
            iconSize: [size, size],
            iconAnchor: [size/2, size],
            popupAnchor: [0, -size]
          });
          
          const marker = L.marker([latlng.lat, latlng.lng], {icon}).addTo(AppState.map);
          marker.likedBy = marker.likedBy || [];
          marker.uploader = user ? user.username : null;
          AppState.allMarkers.push(marker);
          
          MapManager.setupMarkerPopup(marker, imgSrc);
        };
        img.src = imgSrc;
      },
      
      setupMarkerPopup: (marker, imgSrc) => {
        const popupId = `popup_${Date.now()}`;
        const popupContent = `
          <div id="${popupId}" style="max-width:300px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px solid #007bff;border-radius:12px;padding:12px;background:linear-gradient(135deg,#f8f9fa 80%,#e3eafc 100%);box-shadow:0 4px 12px rgba(0,0,0,0.1);">
            <img src='${imgSrc}' style='width:100%;height:auto;max-height:240px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:12px;' />
            <button id="likeBtn_${popupId}" style="padding:8px 20px;font-size:14px;background:#007bff;color:#fff;border:none;border-radius:8px;cursor:pointer;transition:background 0.2s;">Like</button>
          </div>
        `;
        
        marker.bindPopup(popupContent, {
          maxWidth: 350,
          className: 'custom-popup'
        });
        
        marker.on('click', function() {
          marker.openPopup();
          setTimeout(() => {
            const likeBtn = document.getElementById(`likeBtn_${popupId}`);
            if (likeBtn) {
              if (marker.likedBy.includes(AppState.currentUser?.username)) {
                likeBtn.textContent = 'Liked';
                likeBtn.style.background = '#28a745';
                likeBtn.disabled = true;
              }
              likeBtn.onclick = function() {
                if (!marker.likedBy.includes(AppState.currentUser?.username)) {
                  marker.likedBy.push(AppState.currentUser?.username);
                  likeBtn.textContent = 'Liked';
                  likeBtn.style.background = '#28a745';
                  likeBtn.disabled = true;
                  
                  // Fotoğrafı ekleyen kullanıcıya coin +5
                  if (marker.uploader) {
                    const uploaderUser = AppState.users.find(u => u.username === marker.uploader);
                    if (uploaderUser) {
                      if (!uploaderUser.coin) uploaderUser.coin = 0;
                      uploaderUser.coin += 5;
                      if (uploaderUser === AppState.currentUser) UserManager.updateUserStats();
                      
                      const popupStatsDiv = document.getElementById(`userPopupStats_${uploaderUser.username}`);
                      if (popupStatsDiv) {
                        const followers = uploaderUser.followers ? uploaderUser.followers.length : 0;
                        const posts = uploaderUser.posts || 0;
                        popupStatsDiv.innerHTML = `<p><strong>Followers:</strong> ${followers}</p><p><strong>Posts:</strong> ${posts}</p>`;
                      }
                    }
                  }
                }
              };
            }
          }, 100);
        });
      },
      
      showUserPosts: (username) => {
        AppState.allMarkers.forEach(marker => {
          if (marker.uploader === username) {
            if (!AppState.map.hasLayer(marker)) marker.addTo(AppState.map);
          } else {
            if (AppState.map.hasLayer(marker)) AppState.map.removeLayer(marker);
          }
        });
      },
      
      showAllPosts: () => {
        AppState.allMarkers.forEach(marker => {
          if (!AppState.map.hasLayer(marker)) marker.addTo(AppState.map);
        });
      }
    };

    // Kullanıcı yönetimi
    const UserManager = {
      login: () => {
        const username = DOM.username.value;
        const password = DOM.password.value;
        const user = AppState.users.find((u) => u.username === username && u.password === password);

        if (user) {
          DOM.loginContainer.classList.remove("active");
          DOM.userInfo.classList.add("active");
          DOM.userGreeting.textContent = `Hoş geldin, ${user.username}!`;
          AppState.currentUser = user;
          UserManager.updateUserStats();
          UserManager.updateFollowButtons();
          Helpers.clearError();
        } else {
          Helpers.showError("Hatalı kullanıcı adı veya şifre!");
        }
      },
      
      showSwitchForm: () => {
        DOM.userInfo.classList.remove("active");
        DOM.loginContainer.classList.add("active");
        DOM.username.value = "";
        DOM.password.value = "";
        Helpers.clearError();
        DOM.userGreeting.textContent = "Hoş geldin!";
        DOM.userStats.innerHTML = "";
        AppState.currentUser = null;
        UserManager.updateFollowButtons();
      },
      
      updateUserStats: () => {
        if (!AppState.currentUser) return;
        const coin = AppState.currentUser.coin || 0;
        const followers = AppState.currentUser.followers ? AppState.currentUser.followers.length : 0;
        const follows = AppState.currentUser.followingList ? AppState.currentUser.followingList.length : 0;
        const posts = AppState.currentUser.posts || 0;
        DOM.userStats.innerHTML = `
          <p><strong>Coin:</strong> ${coin}</p>
          <p><strong>Post:</strong> ${posts}</p>
          <p><strong>Followers:</strong> ${followers}</p>
          <p><strong>Follows:</strong> ${follows}</p>
        `;
      },
      
      updateFollowButtons: () => {
        document.querySelectorAll('.details').forEach(div => {
          const btn = div.querySelector('button');
          if (btn) {
            const username = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
            if (AppState.currentUser && AppState.currentUser.followingList && AppState.currentUser.followingList.includes(username)) {
              btn.textContent = 'Takip Ediliyor';
              btn.disabled = true;
            } else {
              btn.textContent = 'Follow';
              btn.disabled = false;
            }
          }
        });
      },
      
      follow: (username) => {
        if (!AppState.currentUser) {
          alert("Önce giriş yapmalısınız!");
          return;
        }
        
        if (AppState.currentUser.username === username) {
          alert("Kendinizi takip edemezsiniz!");
          return;
        }
        
        const targetUser = AppState.users.find(user => user.username === username);
        if (!targetUser) return;
        
        if (!AppState.currentUser.followingList) AppState.currentUser.followingList = [];
        if (!targetUser.followers) targetUser.followers = [];
        
        if (!AppState.currentUser.followingList.includes(username)) {
          AppState.currentUser.followingList.push(username);
          targetUser.followers.push(AppState.currentUser.username);
          
          // Her yeni takipçi için +5 coin
          if (!targetUser.coin) targetUser.coin = 0;
          targetUser.coin += 5;
          
          // Eğer oturumda ise istatistikleri güncelle
          if (targetUser === AppState.currentUser) UserManager.updateUserStats();
          
          // Sol panelde güncelle
          const popupStatsDiv = document.getElementById(`userPopupStats_${targetUser.username}`);
          if (popupStatsDiv) {
            const followers = targetUser.followers ? targetUser.followers.length : 0;
            const posts = targetUser.posts || 0;
            popupStatsDiv.innerHTML = `<p><strong>Followers:</strong> ${followers}</p><p><strong>Posts:</strong> ${posts}</p>`;
          }
        }
        
        // Buton metnini değiştir
        const detailsDivs = document.querySelectorAll('.details');
        detailsDivs.forEach(div => {
          const btn = div.querySelector('button');
          if (btn && btn.getAttribute('onclick') === `UserManager.follow('${username}')`) {
            btn.textContent = 'Takip Ediliyor';
            btn.disabled = true;
          }
        });
        
        UserManager.updateUserStats();
      },
      
      initUserList: () => {
        AppState.users.forEach((user) => {
          const li = document.createElement("li");
          li.textContent = user.username;

          // Detay Menüsü
          const details = document.createElement("div");
          details.classList.add("details");
          details.innerHTML = `
            <button onclick="UserManager.follow('${user.username}')">Follow</button>
            <div id="userPopupStats_${user.username}"></div>
          `;
          li.appendChild(details);

          li.addEventListener("click", () => {
            // Sadece seçilen kullanıcının paylaşımlarını göster
            MapManager.showUserPosts(user.username);
            // Alt menüyü açmaya devam et
            const isActive = details.style.display === "block";
            document.querySelectorAll(".details").forEach((d) => (d.style.display = "none"));
            details.style.display = isActive ? "none" : "block";
            if (!isActive) {
              // Dinamik followers ve posts
              const popupStats = document.getElementById(`userPopupStats_${user.username}`);
              const followers = user.followers ? user.followers.length : 0;
              const posts = user.posts || 0;
              popupStats.innerHTML = `<p><strong>Followers:</strong> ${followers}</p><p><strong>Posts:</strong> ${posts}</p>`;
            }
          });

          DOM.topList.appendChild(li);
        });
      }
    };

    // Fotoğraf yükleme işlemleri
    const PhotoManager = {
      init: () => {
        DOM.addPhotoBtn.addEventListener("click", PhotoManager.startPhotoUpload);
        DOM.uploadButton.addEventListener("click", PhotoManager.uploadPhoto);
      },
      
      startPhotoUpload: () => {
        if (!AppState.currentUser) {
          alert("Önce giriş yapmalısınız!");
          return;
        }
        
        DOM.chooseLocationLabel.style.display = "block";
        AppState.map.once("click", (e) => {
          AppState.currentLatLng = e.latlng;
          DOM.photoLocation.textContent = `Konum: [${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}]`;
          DOM.photoForm.classList.add("active");
          DOM.chooseLocationLabel.style.display = "none";
        });
      },
      
      uploadPhoto: () => {
        if (!DOM.photoInput.files.length) {
          alert("Lütfen bir fotoğraf seçin!");
          return;
        }
        
        if (!AppState.currentLatLng) {
          alert("Lütfen bir konum seçin!");
          return;
        }
        
        Helpers.showLoading();
        
        const file = DOM.photoInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const imgSrc = e.target.result;
          
          MapManager.addMarker(AppState.currentLatLng, imgSrc, AppState.currentUser);
          PhotoManager.finishUpload();
        };
        
        reader.readAsDataURL(file);
      },
      
      finishUpload: () => {
        PhotoManager.closeForm();
        Helpers.hideLoading();
        
        // Post sayısını artır
        if (AppState.currentUser) {
          if (!AppState.currentUser.posts) AppState.currentUser.posts = 0;
          AppState.currentUser.posts++;
          if (!AppState.currentUser.coin) AppState.currentUser.coin = 0;
          AppState.currentUser.coin += 10;
          UserManager.updateUserStats();
        }
        
        // Sol panelde güncelle
        const popupStatsDiv = document.getElementById(`userPopupStats_${AppState.currentUser.username}`);
        if (popupStatsDiv) {
          const followers = AppState.currentUser.followers ? AppState.currentUser.followers.length : 0;
          const posts = AppState.currentUser.posts || 0;
          popupStatsDiv.innerHTML = `<p><strong>Followers:</strong> ${followers}</p><p><strong>Posts:</strong> ${posts}</p>`;
        }
        
        // Input'u sıfırla
        DOM.photoInput.value = "";
        AppState.currentLatLng = null;
      },
      
      closeForm: () => {
        DOM.photoForm.classList.remove("active");
        DOM.chooseLocationLabel.style.display = "none";
        DOM.photoInput.value = "";
        AppState.currentLatLng = null;
      }
    };

    // Event listener'ları yönet
    const EventManager = {
      init: () => {
        DOM.homeBtn.addEventListener("click", MapManager.showAllPosts);
        DOM.loginButton.addEventListener("click", UserManager.login);
        DOM.switchUserBtn.addEventListener("click", UserManager.showSwitchForm);
        
        // Enter tuşu ile giriş yapma
        DOM.password.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            UserManager.login();
          }
        });
      }
    };

    // Uygulamayı başlat
    const App = {
      init: () => {
        MapManager.init();
        UserManager.initUserList();
        PhotoManager.init();
        EventManager.init();
        
        // Giriş formunu göster
        DOM.loginContainer.classList.add("active");
      }
    };

    // Sayfa yüklendiğinde uygulamayı başlat
    window.onload = App.init;
  </script>
</body>
</html>